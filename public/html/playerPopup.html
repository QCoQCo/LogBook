<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>LogBook Player</title>
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                background: #f6f8fb;
                font-family: system-ui, Arial;
                color: #222;
            }
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }
            #wrap {
                display: flex;
                height: 100%;
                overflow-x: hidden;
            }
            .left {
                flex: 1;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .right {
                width: 400px;
                border-left: 1px solid #e6e9ee;
                background: #fff;
                padding: 12px 14px;
                box-sizing: border-box;
            }

            @media (max-width: 1000px) {
                .left {
                    flex: 0 0 60%;
                    padding: 20px;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 16px;
                }
                .right {
                    flex: 0 0 40%;
                    border-left: 1px solid #e6e9ee;
                    background: #fff;
                    padding: 12px 14px;
                    box-sizing: border-box;
                }
            }

            #player {
                width: 100%;
                aspect-ratio: 16/9;
                background: #000;
            }
            #wrap {
                margin: 0 auto;
            }
            .controlWrap {
                display: flex;
                gap: 16px;
                flex-direction: column;
                width: 100%;
            }

            .progress {
                width: 100%;
                max-width: 640px;
                height: 6px;
                background: #e9eef7;
                border-radius: 3px;
                overflow: hidden;
            }
            .progress > i {
                display: block;
                height: 100%;
                background: linear-gradient(90deg, #4aa3ff, #6dd3ff);
                width: 0%;
            }
            .controls {
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 640px;
                width: 100%;
                justify-content: flex-start;
            }
            .ctrl-btn {
                width: 36px;
                height: 36px;
                border-radius: 6px;
                border: none;
                background: #fff;
                box-shadow: 0 2px 6px rgba(10, 20, 40, 0.06);
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .time {
                font-size: 12px;
                color: #556;
            }
            .playlist-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 8px;
            }
            .playlist-title {
                font-weight: 700;
            }
            .plist {
                overflow: auto;
                max-height: calc(100% - 48px);
                padding-right: 6px;
            }
            .p-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px;
                border-bottom: 1px solid #f0f2f6;
            }
            .p-item .p-thumb {
                width: 48px;
                height: 48px;
                border-radius: 6px;
                overflow: hidden;
                background: #f3f6fa;
            }
            .p-item .p-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .p-meta {
                flex: 1;
            }
            .p-title {
                font-size: 13px;
                line-height: 1.2;
                color: #1a1a1a;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .p-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .p-actions button {
                border: none;
                background: transparent;
                cursor: pointer;
                color: #5b6b80;
            }
            .p-actions button:hover {
                color: #1e88e5;
            }
            .playlist-controls .clear-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 6px 10px;
                height: 36px;
                border-radius: 8px;
                background: transparent;
                border: 1px solid #eee;
                color: #b71c1c;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
                transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s,
                    color 0.12s;
            }
            .playlist-controls .clear-btn:hover {
                background: rgba(183, 28, 28, 0.06);
                transform: translateY(-1px);
            }
            .playlist-controls .clear-btn:active {
                transform: translateY(0);
                box-shadow: none;
            }
            .playlist-controls .clear-btn:focus {
                outline: 2px solid rgba(183, 28, 28, 0.12);
                outline-offset: 2px;
            }
            .playlist-controls .clear-btn[disabled] {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .p-actions button svg {
                transition: transform 0.12s, color 0.12s;
            }
            .p-item.active .p-title {
                font-weight: 700;
            }
            .p-item.active .p-actions button {
                color: #1e88e5;
                font-weight: 700;
            }
            .p-item.active .p-actions button svg {
                transform: scale(1.06);
            }
        </style>
    </head>
    <body>
        <div id="wrap">
            <div class="left">
                <div id="player"></div>
                <div class="controlWrap">
                    <div class="progress" id="progress"><i id="progBar"></i></div>
                    <div class="controls">
                        <button id="prev" class="ctrl-btn" title="이전">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden
                            >
                                <path
                                    d="M19 20L9 12l10-8v16zM5 20V4"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                        </button>
                        <button id="play" class="ctrl-btn" title="재생">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden
                            >
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </button>
                        <button id="pause" class="ctrl-btn" title="일시정지">
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden
                            >
                                <path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor" />
                            </svg>
                        </button>
                        <button id="next" class="ctrl-btn" title="다음">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden
                            >
                                <path
                                    d="M5 4v16l10-8L5 4zm14 0v16"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                        </button>
                        <div style="flex: 1"></div>
                        <div class="time" id="time">0:00 / 0:00</div>
                    </div>
                </div>
            </div>
            <div class="right">
                <div class="playlist-header">
                    <div class="playlist-title">재생 목록</div>
                    <div class="playlist-controls">
                        <button
                            id="clearAll"
                            class="clear-btn"
                            title="목록 전체 삭제"
                            aria-label="목록 전체 삭제"
                        >
                            전체삭제
                        </button>
                    </div>
                </div>
                <div class="plist" id="plist"></div>
            </div>
        </div>

        <script>
            var __injected = [];
            var startIndex = 0;
            var __clearOnClose = false;
            var STORAGE_KEY = 'logbook_yt_playlist_v1';
            var STORAGE_INDEX_KEY = 'logbook_yt_playlist_index_v1';
            var playlist = [];
            var player;
            var _playerReady = false;
            var _pendingPlay = null;
            var _userInitiatedPlay = false;

            try {
                console.log('[playerPopup] script loaded');
            } catch (e) {}

            function savePlaylist() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(playlist));
                } catch (e) {}
            }
            function saveIndex() {
                try {
                    localStorage.setItem(STORAGE_INDEX_KEY, String(currentIndex()));
                } catch (e) {}
            }

            function mergeInjected() {
                try {
                    var saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
                    if (Array.isArray(saved)) playlist = saved.slice();
                    try {
                        console.log(
                            '[playerPopup] mergeInjected - saved playlist length:',
                            playlist.length
                        );
                    } catch (e) {}
                } catch (e) {
                    playlist = [];
                    try {
                        console.error('[playerPopup] mergeInjected parse error', e);
                    } catch (e) {}
                }
                (Array.isArray(__injected) ? __injected : []).forEach(function (it) {
                    var exists = playlist.some(function (p) {
                        return (
                            (p.contentId && it.contentId && p.contentId === it.contentId) ||
                            (p.videoId && it.videoId && p.videoId === it.videoId) ||
                            (p.link && it.link && p.link === it.link)
                        );
                    });
                    if (!exists) playlist.push(it);
                });
                try {
                    var savedIdx = parseInt(localStorage.getItem(STORAGE_INDEX_KEY), 10);
                    if (!isNaN(savedIdx) && savedIdx >= 0 && savedIdx < playlist.length)
                        startIndex = savedIdx;
                } catch (e) {}
            }

            function updatePlayControls() {
                try {
                    var playBtn = document.getElementById('play');
                    var pauseBtn = document.getElementById('pause');
                    if (!playBtn || !pauseBtn) return;
                    if (!_playerReady || !player) {
                        playBtn.style.display = 'inline-flex';
                        pauseBtn.style.display = 'none';
                        return;
                    }
                    var state = null;
                    try {
                        state = player.getPlayerState();
                    } catch (e) {}
                    if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
                        playBtn.style.display = 'none';
                        pauseBtn.style.display = 'inline-flex';
                    } else {
                        playBtn.style.display = 'inline-flex';
                        pauseBtn.style.display = 'none';
                    }
                } catch (e) {}
            }

            function currentIndex() {
                return (window._curIndex = window._curIndex || startIndex);
            }
            function setIndex(i) {
                window._curIndex = i;
            }

            function playIndex(i, opts) {
                opts = opts || {};
                var userInitiated = !!opts.userInitiated;
                setIndex(i);
                var item = playlist[i];
                if (!item) return;
                if (item.videoId) {
                    if (player && player.loadVideoById && _playerReady) {
                        try {
                            player.loadVideoById(item.videoId);
                            if (userInitiated) player.playVideo();
                        } catch (e) {}
                    } else {
                        if (userInitiated) {
                            try {
                                var container = document.getElementById('player');
                                var iframe = document.createElement('iframe');
                                iframe.width = '100%';
                                iframe.height = '100%';
                                iframe.setAttribute(
                                    'allow',
                                    'autoplay; encrypted-media; picture-in-picture'
                                );
                                iframe.setAttribute('allowfullscreen', '');
                                iframe.src =
                                    'https://www.youtube.com/embed/' +
                                    item.videoId +
                                    '?autoplay=1&enablejsapi=1&controls=0&rel=0&modestbranding=1';
                                container.innerHTML = '';
                                container.appendChild(iframe);
                                _pendingPlay = i;
                                _userInitiatedPlay = true;
                                if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                                    var tag = document.createElement('script');
                                    tag.src = 'https://www.youtube.com/iframe_api';
                                    document.head.appendChild(tag);
                                }
                            } catch (e) {}
                        } else {
                            _pendingPlay = i;
                            if (userInitiated) _userInitiatedPlay = true;
                        }
                    }
                } else if (item.link) {
                    window.open(item.link, '_blank');
                }
                try {
                    localStorage.setItem(STORAGE_INDEX_KEY, String(currentIndex()));
                } catch (e) {}
                updateNow();
                try {
                    if (window.opener) {
                        window.opener.postMessage({ cmd: 'nowPlaying', index: i }, '*');
                    }
                } catch (e) {}
            }

            function updateNow() {
                Array.from(document.querySelectorAll('.p-item')).forEach(function (el, i) {
                    el.classList.toggle('active', i === currentIndex());
                });
            }

            function removeIndex(i) {
                if (!playlist[i]) return;
                playlist.splice(i, 1);
                var wrap = document.getElementById('plist');
                wrap.innerHTML = '';
                buildList();
                savePlaylist();
                if (currentIndex() >= playlist.length) setIndex(Math.max(0, playlist.length - 1));
                saveIndex();
                updateNow();
            }
            function playNext() {
                if (!playlist.length) return;
                var i = (currentIndex() + 1) % playlist.length;
                playIndex(i);
            }
            function playPrev() {
                if (!playlist.length) return;
                var i = (currentIndex() - 1 + playlist.length) % playlist.length;
                playIndex(i);
            }

            function buildList() {
                try {
                    var wrap = document.getElementById('plist');
                    if (!wrap) return;
                    wrap.innerHTML = '';
                    if (!playlist || !playlist.length) {
                        wrap.innerHTML =
                            '<div class="empty" style="padding:16px;color:#556">재생 목록이 비어 있습니다.</div>';
                        try {
                            console.log('[playerPopup] buildList - empty playlist');
                        } catch (e) {}
                        return;
                    }

                    playlist.forEach(function (it, idx) {
                        var el = document.createElement('div');
                        el.className = 'p-item';
                        el.innerHTML =
                            '<div class="p-thumb"><img src="' +
                            (it.thumbnail || '') +
                            '"/></div>' +
                            '<div class="p-meta"><div class="p-title">' +
                            (it.title || '') +
                            '</div></div>' +
                            '<div class="p-actions">' +
                            '<button class="act-play" title="재생">' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 5v14l11-7z"/></svg>' +
                            '</button>' +
                            '<button class="act-del" title="삭제">' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                            '</button>' +
                            '</div>';
                        (function (i) {
                            var playBtn = el.querySelector('.act-play');
                            var delBtn = el.querySelector('.act-del');
                            if (playBtn)
                                playBtn.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    playIndex(i, { userInitiated: true });
                                });
                            if (delBtn)
                                delBtn.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    removeIndex(i);
                                });
                        })(idx);
                        el.addEventListener('click', function (e) {
                            playIndex(idx, { userInitiated: true });
                        });
                        wrap.appendChild(el);
                    });
                    savePlaylist();
                } catch (err) {
                    try {
                        console.error('[playerPopup] buildList error', err);
                    } catch (e) {}
                }
            }

            function receiveMessage(ev) {
                try {
                    try {
                        var safeData = null;
                        try {
                            safeData = JSON.stringify(ev && ev.data);
                        } catch (e) {
                            safeData = String(ev && ev.data);
                        }
                        console.log('[playerPopup] receiveMessage raw', {
                            data: safeData,
                            origin: ev && ev.origin,
                            isOpener: ev && ev.source === window.opener,
                        });
                        try {
                            console.log('[playerPopup] receiveMessage full object:', ev.data);
                        } catch (e) {}
                    } catch (e) {}
                    var allowedOrigin = window.location && window.location.origin;
                    if (!ev || !ev.source) return;
                    if (window.opener && ev.source !== window.opener) return;
                    if (ev.origin && allowedOrigin && ev.origin !== allowedOrigin) return;
                    var d = ev && ev.data;
                    if (!d) {
                        try {
                            console.warn('[playerPopup] receiveMessage - no data, ignoring');
                        } catch (e) {}
                        return;
                    }
                    if (d.cmd === 'init') {
                        if (Array.isArray(d.items) && d.items.length) {
                            __injected = d.items;
                        }
                        startIndex = Number(d.startIndex) || 0;
                        __clearOnClose = !!(d.opts && d.opts.clearOnClose);
                        mergeInjected();
                        // ensure UI and storage are updated immediately when init arrives
                        try {
                            buildList();
                            savePlaylist();
                            saveIndex();
                        } catch (e) {}
                        if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                            var tag = document.createElement('script');
                            tag.src = 'https://www.youtube.com/iframe_api';
                            document.head.appendChild(tag);
                        } else {
                            onYouTubeIframeAPIReady();
                        }
                        if (d.opts && d.opts.autoplay && playlist.length) {
                            var idx = startIndex || playlist.length - 1;
                            _pendingPlay = idx;
                        }
                        try {
                            if (window.opener) {
                                window.opener.postMessage(
                                    { cmd: 'init_ack' },
                                    window.location.origin || '*'
                                );
                            }
                        } catch (e) {}
                    }
                    if (d.cmd === 'append' && Array.isArray(d.items)) {
                        try {
                            console.log('[playerPopup] append received, items:', d.items.length);
                        } catch (e) {}
                        var wrap = document.getElementById('plist');
                        d.items.forEach(function (it) {
                            var exists = playlist.some(function (p) {
                                return (
                                    (p.contentId && it.contentId && p.contentId === it.contentId) ||
                                    (p.videoId && it.videoId && p.videoId === it.videoId) ||
                                    (p.link && it.link && p.link === it.link)
                                );
                            });
                            if (!exists) {
                                playlist.push(it);
                                var idx = playlist.length - 1;
                                var el = document.createElement('div');
                                el.className = 'p-item';
                                el.innerHTML =
                                    '<div class="p-thumb"><img src="' +
                                    (it.thumbnail || '') +
                                    '"/></div>' +
                                    '<div class="p-meta"><div class="p-title">' +
                                    (it.title || '') +
                                    '</div></div>' +
                                    '<div class="p-actions">' +
                                    '<button class="act-play" title="재생">' +
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 5v14l11-7z"/></svg>' +
                                    '</button>' +
                                    '<button class="act-del" title="삭제">' +
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                                    '</button>' +
                                    '</div>';
                                (function (i) {
                                    el.querySelector('.act-play').addEventListener(
                                        'click',
                                        function (e) {
                                            e.stopPropagation();
                                            playIndex(i, { userInitiated: true });
                                        }
                                    );
                                    el.querySelector('.act-del').addEventListener(
                                        'click',
                                        function (e) {
                                            e.stopPropagation();
                                            removeIndex(i);
                                        }
                                    );
                                })(idx);
                                el.addEventListener('click', function (e) {
                                    playIndex(idx, { userInitiated: true });
                                });
                                wrap.appendChild(el);
                                try {
                                    localStorage.setItem(STORAGE_KEY, JSON.stringify(playlist));
                                } catch (e) {}
                            }
                        });
                        updateNow();
                    }
                    if (d.cmd === 'playIndex' && typeof d.index === 'number') {
                        playIndex(d.index);
                    }
                    if (d.cmd === 'playLast') {
                        var li = playlist.length - 1;
                        if (li >= 0) playIndex(li);
                    }
                } catch (e) {}
            }
            window.addEventListener('message', receiveMessage, false);

            document.addEventListener('DOMContentLoaded', function () {
                try {
                    console.log('[playerPopup] DOMContentLoaded - restoring playlist');
                    mergeInjected();
                    buildList();
                    if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                        var tag_init = document.createElement('script');
                        tag_init.src = 'https://www.youtube.com/iframe_api';
                        document.head.appendChild(tag_init);
                    } else {
                        onYouTubeIframeAPIReady();
                    }
                } catch (e) {
                    try {
                        console.error('[playerPopup] DOMContentLoaded init error', e);
                    } catch (e) {}
                }
                try {
                    if ((!playlist || !playlist.length) && window.opener) {
                        try {
                            console.log('[playerPopup] requesting init from opener');
                            window.opener.postMessage(
                                { cmd: 'request_init' },
                                window.location.origin || '*'
                            );
                        } catch (e) {}
                    }
                } catch (e) {}
                setTimeout(function () {
                    try {
                        console.log('[playerPopup] retry init after short delay');
                        mergeInjected();
                        buildList();
                        if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                            var tag_retry = document.createElement('script');
                            tag_retry.src = 'https://www.youtube.com/iframe_api';
                            document.head.appendChild(tag_retry);
                        } else {
                            onYouTubeIframeAPIReady();
                        }
                    } catch (e) {
                        try {
                            console.error('[playerPopup] retry init error', e);
                        } catch (e) {}
                    }
                }, 300);
            });

            function onYouTubeIframeAPIReady() {
                try {
                    var v = playlist[startIndex] && playlist[startIndex].videoId;
                    player = new YT.Player('player', {
                        height: '320',
                        width: '320',
                        videoId: v || '',
                        playerVars: { rel: 0, modestbranding: 1, controls: 0 },
                        events: {
                            onReady: function (e) {
                                _playerReady = true;
                                updateNow();
                                updatePlayControls();
                                if (_pendingPlay !== null) {
                                    try {
                                        playIndex(_pendingPlay, {
                                            userInitiated: !!_userInitiatedPlay,
                                        });
                                    } catch (e) {}
                                    _pendingPlay = null;
                                    _userInitiatedPlay = false;
                                }
                            },
                            onStateChange: function (e) {
                                if (e.data === YT.PlayerState.ENDED) playNext();
                                updatePlayControls();
                            },
                        },
                    });
                } catch (e) {}
            }

            (function () {
                document.getElementById('play').addEventListener('click', function () {
                    playIndex(currentIndex(), { userInitiated: true });
                    setTimeout(updatePlayControls, 120);
                });

                document.getElementById('pause').addEventListener('click', function () {
                    if (player && _playerReady)
                        try {
                            player.pauseVideo();
                        } catch (e) {}
                    setTimeout(updatePlayControls, 120);
                });

                document.getElementById('next').addEventListener('click', playNext);
                document.getElementById('prev').addEventListener('click', playPrev);

                document.getElementById('clearAll').addEventListener('click', function () {
                    playlist = [];
                    document.getElementById('plist').innerHTML = '';
                    savePlaylist();
                    setIndex(0);
                    saveIndex();
                    updateNow();
                });

                setInterval(function () {
                    if (!_playerReady || !player) return;
                    try {
                        var pos =
                            player.getCurrentTime && player.getDuration
                                ? (player.getCurrentTime() / Math.max(1, player.getDuration())) *
                                  100
                                : 0;
                        document.getElementById('progBar').style.width = (pos || 0) + '%';
                        var dur = player.getDuration ? Math.floor(player.getDuration()) : 0;
                        var cur = player.getCurrentTime ? Math.floor(player.getCurrentTime()) : 0;
                        function fmt(s) {
                            return Math.floor(s / 60) + ':' + ('0' + (s % 60)).slice(-2);
                        }
                        document.getElementById('time').textContent = fmt(cur) + ' / ' + fmt(dur);
                    } catch (e) {}
                }, 800);
            })();
        </script>
    </body>
</html>